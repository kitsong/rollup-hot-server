"use strict";var e=require("yargs-parser"),t=require("path"),r=require("process"),o=require("fs"),n=require("url"),s=require("rollup"),i=require("module"),l=require("os"),c=require("colors"),a=require("mime");function u(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}function p(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach((function(r){if("default"!==r){var o=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(t,r,o.get?o:{enumerable:!0,get:function(){return e[r]}})}})),t.default=e,Object.freeze(t)}var h=u(e),d=u(s),f=u(l),v=u(c),g=u(a);const m={c:"config",n:"not",r:"rollup",w:"watch",s:"server",h:"help",v:"version"};function y(e,t,r,o){return new(r||(r=Promise))((function(n,s){function i(e){try{c(o.next(e))}catch(e){s(e)}}function l(e){try{c(o.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(i,l)}c((o=o.apply(e,t||[])).next())}))}function b(e,n){return y(this,void 0,void 0,(function*(){if(e)return t.resolve(e);const s=yield function(e){return y(this,void 0,void 0,(function*(){const n=(yield o.promises.readdir(r.cwd())).filter((r=>{const o=t.extname(r);return t.basename(r,o)===e}));return n.length?n[0]:`${e}.js`}))}(n);return t.resolve(s)}))}function w(){return(new Date).toISOString().replace(/T/," ").replace(/\..+/,"")}function S(e){return y(this,void 0,void 0,(function*(){try{const c=t.extname(e);if(".cjs"===c){return(l=require(e)).__esModule?l.default:l}if(".mjs"===c&&Number(/^v(\d+)/.exec(r.version)[1])>=13){return yield(o=e,Promise.resolve().then((function(){return p(require(o))})))}const a=yield function(e){return y(this,void 0,void 0,(function*(){const r={external:e=>{const r="."!==e[0]&&!t.isAbsolute(e)||".json"===e.slice(-5,e.length);return console.log("temp",r),r},input:e},o=yield s.rollup(r),{output:[{code:i}]}=yield o.generate({exports:"named",format:"cjs",plugins:[{name:"transpile-import-meta",resolveImportMeta:(e,{moduleId:t})=>"url"===e?`'${n.pathToFileURL(t).href}'`:null==e?`{url:'${n.pathToFileURL(t).href}'}`:void 0}]});return i}))}(e),u=function(e,t){const r=new i.Module(e+"?cache");r._compile(t,e);return r.exports.default||r.exports}(e,a);return u}catch(e){return{}}var o,l}))}var j;!function(e){e.STATIC="STATIC",e.UPDATE="UPDATE"}(j||(j={}));const P=new class{constructor(){this.logggers=new Map,this.logggers.set(j.STATIC,[]),this.logggers.set(j.UPDATE,[])}logStatic(e){const t=this.logggers.get(j.STATIC);null==t||t.push(e)}logUpdate(e){this.logggers.set(j.UPDATE,[e])}stage(e){this.logStatic(v.default.green(`- [SUCCESS]: ${v.default.bold(e)}`))}stageFail(e){this.logStatic(v.default.green(`- [SUCCESS]: ${v.default.bold(e)}`))}clear(){this.logggers.forEach(((e,t)=>{this.logggers.set(t,[])}))}version(){this.logStatic("rollup-hot-server -v 1.0.1"),this.logStatic(" ")}server(e){const{protocol:t,port:r,base:o}=e;Object.values(f.default.networkInterfaces()).flatMap((e=>null!=e?e:[])).filter((e=>e&&e.address&&"IPv4"===e.family)).forEach((e=>{this.logStatic(`> ${t}://${v.default.green(e.address)}:${r}${o}`)}))}showUpdate(){console.clear(),this.logggers.forEach(((e,t)=>{const r=this.logggers.get(t);null==r||r.forEach((e=>{console.log(e)}))}))}};function T(e){return y(this,void 0,void 0,(function*(){const o=e.output,n=yield s.rollup(e);P.stage("build"),yield Promise.all(o.map(n.write)),o.forEach((e=>{P.logStatic(`> OUTPUT => ${t.resolve(r.cwd(),e.file)}`)})),P.logStatic(" "),yield n.close()}))}const E={algorithm:"sha256",days:30,keySize:2048,extensions:[{name:"keyUsage",keyCertSign:!0,digitalSignature:!0,nonRepudiation:!0,keyEncipherment:!0,dataEncipherment:!0},{name:"extKeyUsage",serverAuth:!0,clientAuth:!0,codeSigning:!0,timeStamping:!0},{name:"subjectAltName",altNames:[{type:2,value:"localhost"},{type:2,value:"localhost.localdomain"},{type:2,value:"lvh.me"},{type:2,value:"*.lvh.me"},{type:2,value:"[::1]"},{type:7,ip:"127.0.0.1"},{type:7,ip:"fe80::1"}]}]},U=__dirname;function q(){return y(this,void 0,void 0,(function*(){const e=t.join(U,"fake-cert.pem");try{const t=yield function(e,t){return y(this,void 0,void 0,(function*(){try{const r=yield o.promises.stat(e),n=(new Date).getTime();if(n-r.ctime.getTime()<1e3*t*60*60*24*28){const t=yield o.promises.readFile(e,"utf-8");return Promise.resolve(t)}return Promise.reject("overLimit")}catch(e){return Promise.reject("noFile")}}))}(e,28);return Promise.resolve(t)}catch(t){try{const t=require("selfsigned").generate([{name:"commonName",value:"localhost"}],E),r=t.private+t.cert;return o.promises.writeFile(e,r),Promise.resolve(r)}catch(e){return Promise.reject(e)}}}))}class ${constructor(e){this.port=e&&e.port||8e3,this.base=e&&e.base||"",this.https=e&&e.https||!1,this.resolve=e&&e.resolve||{}}}class x{constructor(e){this.config=e,this.close(),this.server=null}createServer(e){return y(this,void 0,void 0,(function*(){try{const t=this.requestListener.bind(this);if(!e)return Promise.resolve(require("http").createServer(t));if("boolean"!=typeof e)return Promise.resolve(require("https").createServer(e,t));const r=yield q(),o={key:r,cert:r};return Promise.resolve(require("https").createServer(o,t))}catch(e){return Promise.reject(e)}}))}listen(){return y(this,void 0,void 0,(function*(){try{const{base:e,port:t,https:r}=this.config;return this.server=yield this.createServer(r),yield this.addlisten(this.server,t),P.stage("server"),P.server({protocol:r?"https":"http",base:e,port:t}),P.logStatic(" "),Promise.resolve()}catch(e){return Promise.reject(e)}}))}addlisten(e,t){return new Promise(((r,o)=>{e?e.listen(t,r):o()}))}close(){this.server&&this.server.close()}requestListener(e,r){return y(this,void 0,void 0,(function*(){const{url:n}=e;let s=n.replace(/#.*$/s,"").replace(/\?.*$/s,"");s=this.resolveBase(s),s=this.resolvePath(s);let i=t.resolve("."+s);s.endsWith("/")&&(i=t.resolve(i,"index.html"));try{const e=yield o.promises.readFile(i),t=g.default.getType(i);r.setHeader("Content-Type",t),r.writeHead(200),r.end(e,"utf-8")}catch(e){r.writeHead(404),r.end("404 Not Found\n\n"+i,"utf-8")}}))}resolvePath(e){const{base:r}=this.config,o=this.config.resolve;for(const n in o){const s=t.join(r,n);if(0===e.indexOf(s)){const i=t.join(r,o[n]),l=t.relative(s,e);return t.resolve(i,l)}}return e}resolveBase(e){const{base:r}=this.config;return t.join(r,e)}}const O=function(){const e=function(e){const t={config:"",rollup:"",server:!0,watch:!0,port:-1,base:"",https:!1,version:!1,help:!1};return console.log("command",e),"string"==typeof e.config&&(t.config=e.config),"string"==typeof e.rollup&&(t.rollup=e.rollup),e.not&&e.rollup&&(t.rollup=!1),e.not&&e.watch&&(t.watch=!1),e.not&&e.server&&(t.server=!1),"number"==typeof e.port&&e.port>0&&(t.port=e.port),e.base&&(t.base=e.base),e.version&&(t.version=!0),e.help&&(t.help=!0),t}(h.default(process.argv.slice(2),{alias:m,configuration:{"camel-case-expansion":!1}}));return e}();O.version?console.log("rollup-hot-server v1.0.1"):O.help?console.log("rollup-hot-server help"):function(e){y(this,void 0,void 0,(function*(){P.version();const r={port:e.port,base:e.base,https:e.https,rollup:e.rollup,watch:e.watch,server:e.server},n=yield function(e,t){return y(this,void 0,void 0,(function*(){const r=yield b(e,t);try{return yield o.promises.access(r),yield S(r)}catch(t){if(e)throw console.error(`Error: file not found: ${e}`),new Error(t);return{}}}))}(e.config,"server.config"),s=function(e,t){const r=function(e,t){let r="";return!1===e&&(r=e),"string"==typeof e&&e&&(r=e),e||(!1===t&&(r=t),"string"==typeof t&&t&&(r=t)),r}(e.rollup,t.rollup),o=(i=e.watch,l=t.watch,!1!==i&&!1!==l),n={port:e.port,base:e.base,https:e.https},s=function(e,t,r){return!1!==e&&!1!==t&&("object"==typeof t?Object.assign(Object.assign({},t),r):{})}(e.server,t.server,n);var i,l;return{rollup:r,watch:o,server:s}}(r,n);if(s.server){const e=new $(s.server),t=new x(e);yield t.listen()}if(!1!==s.rollup){const e="rollup.config",r=require("rollup/loadConfigFile"),o=yield b(s.rollup,e),{options:n}=yield r(o);for(const e of n)yield T(e);s.watch&&function(e){y(this,void 0,void 0,(function*(){const r=d.default.watch(e);P.stage("watch"),r.on("event",(e=>{switch(e.code){case"ERROR":P.logUpdate(`[${w()}] ERROR: ${e.error.message}`);break;case"BUNDLE_START":P.logUpdate(`[${w()}] start compile...`);break;case"BUNDLE_END":P.logUpdate(`[${w()}] SUCCESS: ${e.input} => ${e.output.map((e=>t.basename(e))).join(", ")}`)}P.showUpdate()}))}))}(n)}P.showUpdate()}))}(O);
